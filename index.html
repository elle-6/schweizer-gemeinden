<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Schweizer Gemeinden - Erweiterte Karte mit allen Features</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-sidebar-v2/css/leaflet-sidebar.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        h1 {
            margin: 0;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        #map { 
            height: 700px; 
            width: 100%; 
        }
        .info { 
            padding: 8px 10px; 
            background: white; 
            background: rgba(255,255,255,0.97);
            border-radius: 8px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.15);
            font-size: 14px;
            min-width: 200px;
        }
        .info h4 {
            margin: 0 0 5px;
            color: #667eea;
            font-size: 16px;
        }
        .legend {
            line-height: 20px;
            color: #555;
            padding: 8px 10px;
            background: white;
            background: rgba(255,255,255,0.97);
            border-radius: 8px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.15);
            max-height: 400px;
            overflow-y: auto;
        }
        .legend h4 {
            margin: 0 0 8px;
            color: #667eea;
        }
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
            border: 1px solid #ccc;
        }
        .search-box {
            margin-bottom: 15px;
        }
        #gemeindeSearch {
            width: calc(100% - 70px);
            padding: 8px;
            margin-right: 5px;
            border: 2px solid #667eea;
            border-radius: 5px;
            font-size: 14px;
        }
        .search-btn {
            padding: 8px 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-btn:hover {
            background: #5568d3;
        }
        .chart-container {
            margin: 15px 0;
            height: 250px;
        }
        .export-btn, .sidebar-btn {
            margin: 8px 0;
            padding: 10px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            font-size: 14px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .export-btn:hover, .sidebar-btn:hover {
            background: #764ba2;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
        }
        .export-btn i, .sidebar-btn i {
            width: 20px;
            text-align: center;
        }
        .timeline {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .timeline label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        #yearSlider {
            width: 100%;
            margin: 10px 0;
        }
        .animation-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .animation-controls button {
            flex: 1;
            padding: 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        .animation-controls button:hover {
            background: #5568d3;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 13px;
        }
        .comparison-table th {
            background-color: #667eea;
            color: white;
            font-weight: 600;
        }
        .comparison-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .debug-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fff3cd;
            padding: 12px;
            z-index: 1000;
            border-radius: 6px;
            border: 2px solid #ffc107;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
        }
        .leaflet-sidebar {
            width: 380px;
        }
        .leaflet-sidebar-tabs > ul > li {
            width: 50px;
        }
        .leaflet-sidebar-content {
            padding: 20px;
        }
        .filter-section {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .filter-section h4 {
            margin: 0 0 10px;
            color: #667eea;
        }
        .filter-row {
            margin: 10px 0;
        }
        .filter-row label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 600;
        }
        .filter-row input, .filter-row select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        #comparisonStatus {
            margin: 12px 0;
            padding: 12px;
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border-radius: 8px;
            border: 2px solid #667eea;
        }
        #comparisonStep {
            font-size: 13px;
            line-height: 1.6;
        }
        .feature-badge {
            display: inline-block;
            padding: 4px 8px;
            background: #28a745;
            color: white;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
            font-weight: 600;
        }
        .mode-indicator {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(102, 126, 234, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
        }
        .heatmap-controls {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .heatmap-controls label {
            display: block;
            margin: 8px 0 4px;
            font-size: 13px;
            font-weight: 600;
        }
        .neighbor-highlight {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .multi-compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .multi-compare-card {
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            color: white;
            font-weight: 600;
        }
        
        /* CLUSTER-MARKER STYLES - WICHTIG! */
        .marker-cluster-small {
            background-color: rgba(181, 226, 140, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(110, 204, 57, 0.6);
        }
        .marker-cluster-medium {
            background-color: rgba(241, 211, 87, 0.6);
        }
        .marker-cluster-medium div {
            background-color: rgba(240, 194, 12, 0.6);
        }
        .marker-cluster-large {
            background-color: rgba(253, 156, 115, 0.6);
        }
        .marker-cluster-large div {
            background-color: rgba(241, 128, 23, 0.6);
        }
        
        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
        }
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
            font-weight: bold;
        }
        .marker-cluster span {
            line-height: 30px;
            color: #fff;
        }
    </style>
</head>
<body>
    <h1>🗺️ Schweizer Gemeinden - Interaktive Analyse-Karte</h1>
    
    <div id="debugInfo" class="debug-info" style="display: none;">Debug Info</div>
    <div id="modeIndicator" class="mode-indicator"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Lade Daten und verarbeite Features...</p>
        </div>
    </div>
    
    <div id="sidebar" class="leaflet-sidebar">
        <div class="leaflet-sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab"><i class="fas fa-home"></i></a></li>
                <li><a href="#analytics" role="tab"><i class="fas fa-chart-bar"></i></a></li>
                <li><a href="#filters" role="tab"><i class="fas fa-filter"></i></a></li>
                <li><a href="#visualization" role="tab"><i class="fas fa-eye"></i></a></li>
                <li><a href="#export" role="tab"><i class="fas fa-download"></i></a></li>
                <li><a href="#settings" role="tab"><i class="fas fa-cog"></i></a></li>
            </ul>
        </div>
        <div class="leaflet-sidebar-content">
            <!-- Home Tab -->
            <div class="leaflet-sidebar-pane" id="home">
                <h1 class="leaflet-sidebar-header">
                    Steuerung
                    <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                </h1>
                <div class="search-box">
                    <input type="text" id="gemeindeSearch" placeholder="Gemeinde suchen (Name oder BFS-Nr)...">
                    <button class="search-btn" onclick="searchGemeinde()"><i class="fas fa-search"></i></button>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Darstellung:</label>
                    <select id="styleSelect" onchange="changeStyle(this.value)" style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 5px; font-size: 14px;">
                        <option value="einwohner">Nach Einwohnern</option>
                        <option value="kanton">Nach Kanton</option>
                        <option value="flaeche">Nach Fläche</option>
                        <option value="dichte">Nach Bevölkerungsdichte</option>
                    </select>
                </div>
                
                <button class="sidebar-btn" onclick="startComparison()">
                    <i class="fas fa-balance-scale"></i> 
                    <span>Gemeinden vergleichen</span>
                </button>
                
                <button class="sidebar-btn" onclick="startMultiComparison()">
                    <i class="fas fa-layer-group"></i> 
                    <span>Mehrfachvergleich (3-5 Gemeinden)</span>
                    <span class="feature-badge">NEU</span>
                </button>
                
                <button class="sidebar-btn" onclick="toggleNeighborMode()">
                    <i class="fas fa-project-diagram"></i> 
                    <span>Nachbarschaftsanalyse</span>
                    <span class="feature-badge">NEU</span>
                </button>
                
                <div id="comparisonStatus" style="display: none;">
                    <strong>Modus aktiv:</strong>
                    <div id="comparisonStep"></div>
                </div>
                
                <div class="timeline">
                    <label>📅 Zeitreise-Simulation: <span id="currentYear" style="color: #667eea; font-size: 18px;">2024</span></label>
                    <input type="range" id="yearSlider" min="2000" max="2030" value="2024" oninput="updateYear(this.value)">
                    <div class="animation-controls">
                        <button onclick="startAnimation()"><i class="fas fa-play"></i> Abspielen</button>
                        <button onclick="stopAnimation()"><i class="fas fa-stop"></i> Stoppen</button>
                        <button onclick="resetAnimation()"><i class="fas fa-undo"></i> Zurücksetzen</button>
                    </div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div class="leaflet-sidebar-pane" id="analytics">
                <h1 class="leaflet-sidebar-header">
                    Analytics & Statistiken
                    <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                </h1>
                <div id="analyticsContent">
                    <p style="color: #666; text-align: center; padding: 20px;">Klicke auf eine Gemeinde, um detaillierte Statistiken zu sehen</p>
                </div>
                <div class="chart-container">
                    <canvas id="statsChart"></canvas>
                </div>
            </div>

            <!-- Filters Tab -->
            <div class="leaflet-sidebar-pane" id="filters">
                <h1 class="leaflet-sidebar-header">
                    Filter & Auswahl <span class="feature-badge">NEU</span>
                    <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                </h1>
                
                <div class="filter-section">
                    <h4><i class="fas fa-users"></i> Einwohner</h4>
                    <div class="filter-row">
                        <label>Minimum:</label>
                        <input type="number" id="filterEinwohnerMin" placeholder="z.B. 10000">
                    </div>
                    <div class="filter-row">
                        <label>Maximum:</label>
                        <input type="number" id="filterEinwohnerMax" placeholder="z.B. 500000">
                    </div>
                </div>
                
                <div class="filter-section">
                    <h4><i class="fas fa-map"></i> Fläche (Hektar)</h4>
                    <div class="filter-row">
                        <label>Minimum:</label>
                        <input type="number" id="filterFlaecheMin" placeholder="z.B. 500">
                    </div>
                    <div class="filter-row">
                        <label>Maximum:</label>
                        <input type="number" id="filterFlaecheMax" placeholder="z.B. 10000">
                    </div>
                </div>
                
                <div class="filter-section">
                    <h4><i class="fas fa-chart-area"></i> Bevölkerungsdichte (Ew./km²)</h4>
                    <div class="filter-row">
                        <label>Minimum:</label>
                        <input type="number" id="filterDichteMin" placeholder="z.B. 100">
                    </div>
                    <div class="filter-row">
                        <label>Maximum:</label>
                        <input type="number" id="filterDichteMax" placeholder="z.B. 5000">
                    </div>
                </div>
                
                <button class="sidebar-btn" onclick="applyFilters()">
                    <i class="fas fa-check"></i> Filter anwenden
                </button>
                <button class="sidebar-btn" onclick="clearFilters()" style="background: #6c757d;">
                    <i class="fas fa-times"></i> Filter zurücksetzen
                </button>
                
                <div id="filterResults" style="margin-top: 15px; padding: 12px; background: #e7f3ff; border-radius: 6px; display: none;">
                    <strong>Ergebnis:</strong>
                    <p id="filterResultText" style="margin: 5px 0 0;"></p>
                </div>
            </div>

            <!-- Visualization Tab -->
            <div class="leaflet-sidebar-pane" id="visualization">
                <h1 class="leaflet-sidebar-header">
                    Visualisierung <span class="feature-badge">NEU</span>
                    <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                </h1>
                
                <div class="heatmap-controls">
                    <h4><i class="fas fa-fire"></i> Heatmap-Modus</h4>
                    <p style="font-size: 12px; color: #666; margin: 0 0 10px;">Zeigt Dichtegradient über die ganze Schweiz</p>
                    <button class="sidebar-btn" onclick="toggleHeatmap()">
                        <i class="fas fa-fire"></i> Heatmap aktivieren/deaktivieren
                    </button>
                    
                    <div style="margin-top: 15px;">
                        <label>Intensität:</label>
                        <input type="range" id="heatmapIntensity" min="0.1" max="2" step="0.1" value="1" oninput="updateHeatmapIntensity(this.value)" style="width: 100%;">
                    </div>
                </div>
                
                <div class="heatmap-controls" style="margin-top: 15px;">
                    <h4><i class="fas fa-th"></i> Cluster-Modus</h4>
                    <p style="font-size: 12px; color: #666; margin: 0 0 10px;">Gruppiert nahe Gemeinden bei niedriger Zoom-Stufe</p>
                    <button class="sidebar-btn" onclick="toggleCluster()">
                        <i class="fas fa-object-group"></i> Clustering aktivieren/deaktivieren
                    </button>
                </div>
                
                <div class="heatmap-controls" style="margin-top: 15px;">
                    <h4><i class="fas fa-bezier-curve"></i> Voronoi-Diagramm</h4>
                    <p style="font-size: 12px; color: #666; margin: 0 0 10px;">Zeigt Einflussgebiete der Gemeindezentren</p>
                    <button class="sidebar-btn" onclick="toggleVoronoi()">
                        <i class="fas fa-th-large"></i> Voronoi aktivieren/deaktivieren
                    </button>
                </div>
            </div>

            <!-- Export Tab -->
            <div class="leaflet-sidebar-pane" id="export">
                <h1 class="leaflet-sidebar-header">
                    Export & Daten
                    <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                </h1>
                <button class="export-btn" onclick="exportScreenshot()">
                    <i class="fas fa-camera"></i> Screenshot erstellen
                </button>
                <button class="export-btn" onclick="exportGeoJSON()">
                    <i class="fas fa-map"></i> GeoJSON exportieren
                </button>
                <button class="export-btn" onclick="exportCSV()">
                    <i class="fas fa-table"></i> Daten als CSV
                </button>
                <button class="export-btn" onclick="exportFilteredData()">
                    <i class="fas fa-filter"></i> Gefilterte Daten (CSV)
                    <span class="feature-badge">NEU</span>
                </button>
                <button class="export-btn" onclick="exportComparisonReport()">
                    <i class="fas fa-file-pdf"></i> Vergleichsbericht
                    <span class="feature-badge">NEU</span>
                </button>
            </div>

            <!-- Settings Tab -->
            <div class="leaflet-sidebar-pane" id="settings">
                <h1 class="leaflet-sidebar-header">
                    Einstellungen
                    <span class="leaflet-sidebar-close"><i class="fas fa-caret-left"></i></span>
                </h1>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Basiskarte:</label>
                    <select id="baseMapSelect" onchange="changeBaseMap(this.value)" style="width: 100%; padding: 10px; border: 2px solid #667eea; border-radius: 5px; font-size: 14px;">
                        <option value="osm">OpenStreetMap</option>
                        <option value="dark">Dark Mode</option>
                        <option value="satellite">Satellit</option>
                        <option value="terrain">Terrain</option>
                    </select>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="debugMode" onchange="toggleDebug(this.checked)" style="margin-right: 10px;">
                        <span style="font-weight: 600;">Debug-Modus aktivieren</span>
                    </label>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="autoSaveMode" onchange="toggleAutoSave(this.checked)" style="margin-right: 10px;">
                        <span style="font-weight: 600;">Auto-Save Position</span>
                    </label>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">Animationsgeschwindigkeit:</label>
                    <input type="range" id="animSpeed" min="100" max="2000" step="100" value="500" oninput="updateAnimSpeed(this.value)" style="width: 100%;">
                    <span id="animSpeedValue" style="font-size: 12px; color: #666;">500ms</span>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-sidebar-v2/js/leaflet-sidebar.min.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>

    <script>
        /*
         * ==============================================
         * ZENTRALE STATE-VERWALTUNG
         * ==============================================
         * Hier speichern wir den gesamten Zustand der Anwendung in einem zentralen Objekt.
         * Das macht es einfacher, verschiedene Features zu koordinieren und den Überblick zu behalten.
         * Statt viele globale Variablen zu haben, haben wir nun ein einziges State-Objekt.
         */
        const AppState = {
            // Karten-Objekte
            map: null,
            geojsonLayer: null,
            heatmapLayer: null,
            voronoiLayer: null,
            clusterGroup: null,  // NEU: Für Marker-Clustering
            allFeatures: [],
            
            // UI-Controls
            infoControl: null,
            legendControl: null,
            sidebar: null,
            
            // Basiskarten
            osmLayer: null,
            darkLayer: null,
            satelliteLayer: null,
            terrainLayer: null,
            currentBaseMap: 'osm',
            
            // Aktuelle Modi und Einstellungen
            currentStyle: 'einwohner',
            comparisonMode: false,
            multiComparisonMode: false,
            neighborMode: false,
            selectedGemeinden: [],
            heatmapActive: false,
            clusterActive: false,  // Status des Cluster-Modus
            voronoiActive: false,
            
            // Animation
            animationRunning: false,
            animationInterval: null,
            animationSpeed: 500,
            
            // Filter
            activeFilters: {
                einwohnerMin: null,
                einwohnerMax: null,
                flaecheMin: null,
                flaecheMax: null,
                dichteMin: null,
                dichteMax: null
            },
            filteredFeatures: [],
            
            // Charts
            statsChart: null,
            
            // Settings
            debugMode: false,
            autoSave: false
        };

        /*
         * ==============================================
         * BEISPIELDATEN
         * ==============================================
         * Diese Daten dienen als Fallback, falls die externe GeoJSON-Datei nicht geladen werden kann.
         * Ich habe hier 15 wichtige Schweizer Städte mit realistischen Daten eingefügt.
         */
        const sampleGeoJSON = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Zürich",
                        "BFS_NUMMER": 261,
                        "KANTONSNUM": "1",
                        "EINWOHNERZ": 421878,
                        "GEM_FLAECH": 8778
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [8.48, 47.34], [8.58, 47.34], [8.58, 47.40], [8.48, 47.40], [8.48, 47.34]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Genf",
                        "BFS_NUMMER": 6621,
                        "KANTONSNUM": "25",
                        "EINWOHNERZ": 203856,
                        "GEM_FLAECH": 1592
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [6.10, 46.18], [6.20, 46.18], [6.20, 46.25], [6.10, 46.25], [6.10, 46.18]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Basel",
                        "BFS_NUMMER": 2701,
                        "KANTONSNUM": "12",
                        "EINWOHNERZ": 177654,
                        "GEM_FLAECH": 2387
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [7.57, 47.54], [7.62, 47.54], [7.62, 47.58], [7.57, 47.58], [7.57, 47.54]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Bern",
                        "BFS_NUMMER": 351,
                        "KANTONSNUM": "2",
                        "EINWOHNERZ": 144074,
                        "GEM_FLAECH": 5196
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [7.40, 46.93], [7.50, 46.93], [7.50, 47.00], [7.40, 47.00], [7.40, 46.93]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Lausanne",
                        "BFS_NUMMER": 5586,
                        "KANTONSNUM": "22",
                        "EINWOHNERZ": 146372,
                        "GEM_FLAECH": 4138
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [6.60, 46.50], [6.70, 46.50], [6.70, 46.56], [6.60, 46.56], [6.60, 46.50]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Winterthur",
                        "BFS_NUMMER": 230,
                        "KANTONSNUM": "1",
                        "EINWOHNERZ": 114220,
                        "GEM_FLAECH": 6807
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [8.70, 47.48], [8.78, 47.48], [8.78, 47.52], [8.70, 47.52], [8.70, 47.48]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Luzern",
                        "BFS_NUMMER": 1061,
                        "KANTONSNUM": "3",
                        "EINWOHNERZ": 82620,
                        "GEM_FLAECH": 2922
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [8.28, 47.03], [8.36, 47.03], [8.36, 47.07], [8.28, 47.07], [8.28, 47.03]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "St. Gallen",
                        "BFS_NUMMER": 3203,
                        "KANTONSNUM": "17",
                        "EINWOHNERZ": 76213,
                        "GEM_FLAECH": 3956
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [9.35, 47.41], [9.42, 47.41], [9.42, 47.45], [9.35, 47.45], [9.35, 47.41]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Lugano",
                        "BFS_NUMMER": 5192,
                        "KANTONSNUM": "21",
                        "EINWOHNERZ": 62315,
                        "GEM_FLAECH": 7563
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [8.92, 45.98], [9.00, 45.98], [9.00, 46.03], [8.92, 46.03], [8.92, 45.98]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Biel/Bienne",
                        "BFS_NUMMER": 371,
                        "KANTONSNUM": "2",
                        "EINWOHNERZ": 55439,
                        "GEM_FLAECH": 2132
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [7.23, 47.13], [7.28, 47.13], [7.28, 47.16], [7.23, 47.16], [7.23, 47.13]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Thun",
                        "BFS_NUMMER": 942,
                        "KANTONSNUM": "2",
                        "EINWOHNERZ": 43476,
                        "GEM_FLAECH": 2165
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [7.61, 46.74], [7.66, 46.74], [7.66, 46.78], [7.61, 46.78], [7.61, 46.74]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Köniz",
                        "BFS_NUMMER": 355,
                        "KANTONSNUM": "2",
                        "EINWOHNERZ": 41784,
                        "GEM_FLAECH": 5108
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [7.38, 46.91], [7.43, 46.91], [7.43, 46.95], [7.38, 46.95], [7.38, 46.91]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "La Chaux-de-Fonds",
                        "BFS_NUMMER": 6421,
                        "KANTONSNUM": "24",
                        "EINWOHNERZ": 36915,
                        "GEM_FLAECH": 5519
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [6.80, 47.08], [6.86, 47.08], [6.86, 47.12], [6.80, 47.12], [6.80, 47.08]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Schaffhausen",
                        "BFS_NUMMER": 2939,
                        "KANTONSNUM": "14",
                        "EINWOHNERZ": 36587,
                        "GEM_FLAECH": 2977
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [8.62, 47.69], [8.67, 47.69], [8.67, 47.72], [8.62, 47.72], [8.62, 47.69]
                        ]]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "NAME": "Fribourg",
                        "BFS_NUMMER": 2196,
                        "KANTONSNUM": "10",
                        "EINWOHNERZ": 38039,
                        "GEM_FLAECH": 916
                    },
                    "geometry": {
                        "type": "Polygon",
                        "coordinates": [[
                            [7.14, 46.79], [7.18, 46.79], [7.18, 46.82], [7.14, 46.82], [7.14, 46.79]
                        ]]
                    }
                }
            ]
        };

        /*
         * ==============================================
         * HILFSFUNKTIONEN
         * ==============================================
         */
        
        function debugLog(message) {
            if (AppState.debugMode) {
                console.log('🐛 DEBUG:', message);
                document.getElementById('debugInfo').innerHTML = `<strong>Debug:</strong><br>${message}`;
                document.getElementById('debugInfo').style.display = 'block';
            }
        }

        function toggleDebug(enabled) {
            AppState.debugMode = enabled;
            document.getElementById('debugInfo').style.display = enabled ? 'block' : 'none';
            debugLog('Debug-Modus ' + (enabled ? 'aktiviert' : 'deaktiviert'));
        }

        function showLoading(show = true) {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        function showModeIndicator(text) {
            const indicator = document.getElementById('modeIndicator');
            indicator.textContent = text;
            indicator.style.display = 'block';
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        /*
         * ==============================================
         * KARTEN-INITIALISIERUNG
         * ==============================================
         */
        
        function initMap() {
            AppState.map = L.map('map').setView([46.8, 8.3], 8);
            
            // Verschiedene Basiskarten definieren
            AppState.osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            });

            AppState.darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '© CartoDB'
            });

            AppState.satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri'
            });

            AppState.terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap'
            });

            AppState.osmLayer.addTo(AppState.map);
            
            // Event-Listener für Karte
            AppState.map.on('zoomend', handleZoomChange);
            
            debugLog('Karte initialisiert');
        }

        function initSidebar() {
            AppState.sidebar = L.control.sidebar('sidebar', {
                position: 'left'
            }).addTo(AppState.map);
            debugLog('Sidebar initialisiert');
        }

        /*
         * ==============================================
         * STYLE-FUNKTIONEN
         * ==============================================
         * Diese Funktionen bestimmen, wie die Gemeinden eingefärbt werden.
         */
        
        function getEinwohnerStyle(feature) {
            const einwohner = feature.properties.simulatedEinwohner || feature.properties.EINWOHNERZ || 0;
            const colors = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#BD0026', '#800026'];
            const breaks = [0, 100, 500, 1000, 2000, 5000, 10000, 20000];
            
            let color = colors[0];
            for (let i = 0; i < breaks.length - 1; i++) {
                if (einwohner >= breaks[i] && einwohner < breaks[i + 1]) {
                    color = colors[i];
                    break;
                } else if (einwohner >= breaks[breaks.length - 1]) {
                    color = colors[colors.length - 1];
                }
            }

            return {
                fillColor: color,
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }

        function getKantonStyle(feature) {
            const kantonNum = feature.properties.KANTONSNUM || '0';
            const kantonColors = {
                '1': '#ff0000', '2': '#0000ff', '3': '#00ff00', '4': '#ffff00',
                '5': '#ff00ff', '6': '#00ffff', '7': '#ff8000', '8': '#8000ff',
                '9': '#008000', '10': '#800000', '11': '#008080', '12': '#808000',
                '13': '#800080', '14': '#000080', '15': '#808080', '16': '#ff8080',
                '17': '#80ff80', '18': '#8080ff', '19': '#ffff80', '20': '#ff80ff',
                '21': '#80ffff', '22': '#804000', '23': '#408080', '24': '#a0522d',
                '25': '#da70d6', '26': '#ff4500'
            };
            
            return {
                fillColor: kantonColors[kantonNum] || '#cccccc',
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }

        function getFlaecheStyle(feature) {
            const flaeche = feature.properties.GEM_FLAECH || 0;
            const intensity = Math.min(flaeche / 10000, 1);
            const color = `rgb(${Math.floor(100 * intensity)}, ${Math.floor(150 * intensity)}, ${Math.floor(200 * intensity)})`;
            
            return {
                fillColor: color,
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }

        function getBevölkerungsdichteStyle(feature) {
            const einwohner = feature.properties.simulatedEinwohner || feature.properties.EINWOHNERZ || 0;
            const flaeche = feature.properties.GEM_FLAECH || 1;
            const dichte = flaeche > 0 ? einwohner / (flaeche / 100) : 0;
            
            const colors = ['#f7fbff', '#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#08519c', '#08306b'];
            const breaks = [0, 50, 100, 200, 500, 1000, 2000, 5000, 10000];
            
            let color = colors[0];
            for (let i = 0; i < breaks.length - 1; i++) {
                if (dichte >= breaks[i] && dichte < breaks[i + 1]) {
                    color = colors[i];
                    break;
                } else if (dichte >= breaks[breaks.length - 1]) {
                    color = colors[colors.length - 1];
                }
            }

            return {
                fillColor: color,
                weight: 1,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }

        function getCurrentStyle() {
            switch(AppState.currentStyle) {
                case 'kanton': return getKantonStyle;
                case 'flaeche': return getFlaecheStyle;
                case 'dichte': return getBevölkerungsdichteStyle;
                default: return getEinwohnerStyle;
            }
        }

        /*
         * ==============================================
         * INTERAKTIONSFUNKTIONEN
         * ==============================================
         * Diese Funktionen behandeln Mouseover, Click, etc.
         */
        
        function highlightFeature(e) {
            const layer = e.target;
            
            if (!layer._originalStyle) {
                layer._originalStyle = {
                    fillColor: layer.options.fillColor,
                    fillOpacity: layer.options.fillOpacity,
                    weight: layer.options.weight,
                    color: layer.options.color,
                    opacity: layer.options.opacity
                };
            }
            
            layer.setStyle({
                weight: 3,
                color: '#333',
                fillOpacity: 0.9
            });
            
            layer.bringToFront();
            
            if (layer.feature && layer.feature.properties) {
                updateInfo(layer.feature.properties);
            }
        }

        function resetHighlight(e) {
            const layer = e.target;
            
            if (layer._originalStyle && !layer._isSelectedForComparison && !layer._isNeighbor) {
                layer.setStyle(layer._originalStyle);
            }
            
            updateInfo();
        }

        function onEachFeature(feature, layer) {
            const initialStyle = getCurrentStyle()(feature);
            layer.setStyle(initialStyle);
            
            layer._originalStyle = {
                fillColor: initialStyle.fillColor,
                fillOpacity: initialStyle.fillOpacity,
                weight: initialStyle.weight,
                color: initialStyle.color,
                opacity: initialStyle.opacity
            };
            layer._isSelectedForComparison = false;
            layer._isNeighbor = false;
            layer._isFiltered = false;
            
            layer.on('click', function(e) {
                handleLayerClick(e);
            });
            
            layer.on('mouseover', function(e) {
                highlightFeature(e);
            });
            
            layer.on('mouseout', function(e) {
                resetHighlight(e);
            });
            
            AppState.allFeatures.push({
                layer: layer,
                name: feature.properties.NAME,
                kanton: feature.properties.KANTONSNUM,
                bfs: feature.properties.BFS_NUMMER,
                feature: feature
            });
        }

        /*
         * ==============================================
         * CLICK-HANDLER
         * ==============================================
         * Intelligenter Click-Handler der unterschiedliche Modi unterstützt
         */
        
        function handleLayerClick(e) {
            const layer = e.target;
            const feature = layer.feature;
            
            debugLog(`Click auf: ${feature.properties.NAME}`);
            
            if (AppState.neighborMode) {
                showNeighbors(layer, feature);
            } else if (AppState.comparisonMode || AppState.multiComparisonMode) {
                handleComparisonClick(e);
            } else {
                // Normaler Modus: Zoom und Analytics
                AppState.map.fitBounds(e.target.getBounds(), { padding: [20, 20], maxZoom: 12 });
                showGemeindeAnalytics(feature);
            }
        }

        /*
         * ==============================================
         * VERGLEICHSMODUS (2 GEMEINDEN)
         * ==============================================
         */
        
        function startComparison() {
            debugLog("Starte 2-Gemeinden-Vergleich");
            
            resetAllModes();
            AppState.comparisonMode = true;
            AppState.selectedGemeinden = [];
            
            document.getElementById('comparisonStatus').style.display = 'block';
            document.getElementById('comparisonStep').innerHTML = '🟦 Klicke auf die erste Gemeinde...';
            
            showModeIndicator('Vergleichsmodus: Wähle 2 Gemeinden');
            updateInfo({NAME: "Vergleichsmodus: Klicke erste Gemeinde"});
            
            AppState.sidebar.open('home');
        }

        function handleComparisonClick(e) {
            const layer = e.target;
            const feature = layer.feature;
            
            const alreadySelected = AppState.selectedGemeinden.find(g => 
                g.properties.BFS_NUMMER === feature.properties.BFS_NUMMER
            );
            
            if (alreadySelected) {
                debugLog("Bereits ausgewählt");
                return;
            }
            
            // Multi-Vergleich: bis zu 5 Gemeinden
            if (AppState.multiComparisonMode) {
                if (AppState.selectedGemeinden.length >= 5) {
                    alert('Maximal 5 Gemeinden können verglichen werden!');
                    return;
                }
                
                AppState.selectedGemeinden.push(feature);
                layer._isSelectedForComparison = true;
                
                const colors = ['#3366ff', '#ff3333', '#00cc00', '#ff9900', '#9933ff'];
                const color = colors[AppState.selectedGemeinden.length - 1];
                
                const comparisonStyle = {
                    fillColor: color,
                    fillOpacity: 0.8,
                    weight: 4,
                    color: '#000',
                    opacity: 1
                };
                layer.setStyle(comparisonStyle);
                layer._originalStyle = comparisonStyle;
                
                updateMultiComparisonStatus();
                
                if (AppState.selectedGemeinden.length >= 3) {
                    document.getElementById('comparisonStep').innerHTML += 
                        '<br><button class="sidebar-btn" onclick="showMultiComparison()" style="margin-top: 10px;">✅ Vergleich jetzt anzeigen</button>';
                }
            } else {
                // Normaler 2-Gemeinden-Vergleich
                AppState.selectedGemeinden.push(feature);
                layer._isSelectedForComparison = true;
                
                const color = AppState.selectedGemeinden.length === 1 ? '#3366ff' : '#ff3333';
                
                const comparisonStyle = {
                    fillColor: color,
                    fillOpacity: 0.8,
                    weight: 4,
                    color: '#000',
                    opacity: 1
                };
                layer.setStyle(comparisonStyle);
                layer._originalStyle = comparisonStyle;
                
                if (AppState.selectedGemeinden.length === 1) {
                    document.getElementById('comparisonStep').innerHTML = 
                        `🟦 Erste Gemeinde: <strong>${feature.properties.NAME}</strong><br>🟥 Klicke zweite Gemeinde...`;
                } else if (AppState.selectedGemeinden.length === 2) {
                    document.getElementById('comparisonStep').innerHTML = 
                        `🟦 ${AppState.selectedGemeinden[0].properties.NAME}<br>🟥 ${AppState.selectedGemeinden[1].properties.NAME}<br>✅ Erstelle Vergleich...`;
                    
                    setTimeout(() => {
                        showComparison();
                        resetAllModes();
                    }, 500);
                }
            }
        }

        function showComparison() {
            const [gemA, gemB] = AppState.selectedGemeinden;
            
            const dichteA = gemA.properties.GEM_FLAECH ? 
                Math.round((gemA.properties.EINWOHNERZ || 0) / (gemA.properties.GEM_FLAECH / 100)) : 0;
            const dichteB = gemB.properties.GEM_FLAECH ? 
                Math.round((gemB.properties.EINWOHNERZ || 0) / (gemB.properties.GEM_FLAECH / 100)) : 0;
            
            const einwohnerDiff = (gemB.properties.EINWOHNERZ || 0) - (gemA.properties.EINWOHNERZ || 0);
            const einwohnerDiffPercent = gemA.properties.EINWOHNERZ ? 
                ((einwohnerDiff / gemA.properties.EINWOHNERZ) * 100).toFixed(1) : 'N/A';

            const content = `
                <h3>📊 Gemeindevergleich</h3>
                <div style="display: flex; margin: 10px 0; gap: 10px;">
                    <div style="flex: 1; background:#3366ff; color:white; padding:12px; border-radius: 8px;">
                        <strong>🟦 ${gemA.properties.NAME}</strong>
                    </div>
                    <div style="flex: 1; background:#ff3333; color:white; padding:12px; border-radius: 8px;">
                        <strong>🟥 ${gemB.properties.NAME}</strong>
                    </div>
                </div>
                
                <table class="comparison-table">
                    <tr><th>Kriterium</th><th>${gemA.properties.NAME}</th><th>${gemB.properties.NAME}</th><th>Unterschied</th></tr>
                    <tr>
                        <td>👥 Einwohner</td>
                        <td>${(gemA.properties.EINWOHNERZ || 0).toLocaleString('de-CH')}</td>
                        <td>${(gemB.properties.EINWOHNERZ || 0).toLocaleString('de-CH')}</td>
                        <td style="color: ${einwohnerDiff >= 0 ? 'green' : 'red'}; font-weight: 600;">
                            ${einwohnerDiff >= 0 ? '+' : ''}${einwohnerDiff.toLocaleString('de-CH')}<br>
                            (${einwohnerDiffPercent}%)
                        </td>
                    </tr>
                    <tr>
                        <td>📐 Fläche (ha)</td>
                        <td>${(gemA.properties.GEM_FLAECH || 0).toLocaleString('de-CH')}</td>
                        <td>${(gemB.properties.GEM_FLAECH || 0).toLocaleString('de-CH')}</td>
                        <td>${((gemB.properties.GEM_FLAECH || 0) - (gemA.properties.GEM_FLAECH || 0)).toLocaleString('de-CH')}</td>
                    </tr>
                    <tr>
                        <td>🏙️ Dichte (Ew./km²)</td>
                        <td>${dichteA.toLocaleString('de-CH')}</td>
                        <td>${dichteB.toLocaleString('de-CH')}</td>
                        <td>${(dichteB - dichteA).toLocaleString('de-CH')}</td>
                    </tr>
                    <tr>
                        <td>🔢 BFS-Nr</td>
                        <td>${gemA.properties.BFS_NUMMER || '-'}</td>
                        <td>${gemB.properties.BFS_NUMMER || '-'}</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>🏛️ Kanton</td>
                        <td>${gemA.properties.KANTONSNUM || '-'}</td>
                        <td>${gemB.properties.KANTONSNUM || '-'}</td>
                        <td>-</td>
                    </tr>
                </table>
                
                <button class="sidebar-btn" onclick="startComparison()" style="background: #28a745; margin-top: 15px;">
                    <i class="fas fa-sync"></i> Neuen Vergleich starten
                </button>
            `;
            
            document.getElementById('analyticsContent').innerHTML = content;
            AppState.sidebar.open('analytics');
        }

        /*
         * ==============================================
         * MEHRFACH-VERGLEICHSMODUS (3-5 GEMEINDEN)
         * ==============================================
         * NEU: Ermöglicht den Vergleich von bis zu 5 Gemeinden gleichzeitig
         */
        
        function startMultiComparison() {
            debugLog("Starte Mehrfach-Vergleich");
            
            resetAllModes();
            AppState.multiComparisonMode = true;
            AppState.selectedGemeinden = [];
            
            document.getElementById('comparisonStatus').style.display = 'block';
            document.getElementById('comparisonStep').innerHTML = 
                '🔵 Wähle 3-5 Gemeinden zum Vergleichen<br><small>Klicke auf die Karte</small>';
            
            showModeIndicator('Mehrfach-Vergleich: Wähle 3-5 Gemeinden');
            AppState.sidebar.open('home');
        }

        function updateMultiComparisonStatus() {
            const count = AppState.selectedGemeinden.length;
            const names = AppState.selectedGemeinden.map(g => g.properties.NAME).join(', ');
            
            document.getElementById('comparisonStep').innerHTML = 
                `<strong>${count} Gemeinden ausgewählt:</strong><br>
                <small>${names}</small><br>
                ${count < 3 ? `<small>Noch ${3 - count} Gemeinde(n) mindestens auswählen</small>` : ''}`;
        }

        function showMultiComparison() {
            if (AppState.selectedGemeinden.length < 3) {
                alert('Bitte mindestens 3 Gemeinden auswählen!');
                return;
            }
            
            const colors = ['#3366ff', '#ff3333', '#00cc00', '#ff9900', '#9933ff'];
            
            let cardsHTML = '<div class="multi-compare-grid">';
            AppState.selectedGemeinden.forEach((gem, idx) => {
                cardsHTML += `
                    <div class="multi-compare-card" style="background: ${colors[idx]};">
                        ${gem.properties.NAME}
                    </div>`;
            });
            cardsHTML += '</div>';
            
            let tableHTML = `
                <h3>📊 Mehrfachvergleich (${AppState.selectedGemeinden.length} Gemeinden)</h3>
                ${cardsHTML}
                <table class="comparison-table">
                    <tr>
                        <th>Kriterium</th>`;
            
            AppState.selectedGemeinden.forEach(gem => {
                tableHTML += `<th>${gem.properties.NAME}</th>`;
            });
            tableHTML += '</tr>';
            
            // Einwohner
            tableHTML += '<tr><td>👥 Einwohner</td>';
            AppState.selectedGemeinden.forEach(gem => {
                tableHTML += `<td>${(gem.properties.EINWOHNERZ || 0).toLocaleString('de-CH')}</td>`;
            });
            tableHTML += '</tr>';
            
            // Fläche
            tableHTML += '<tr><td>📐 Fläche (ha)</td>';
            AppState.selectedGemeinden.forEach(gem => {
                tableHTML += `<td>${(gem.properties.GEM_FLAECH || 0).toLocaleString('de-CH')}</td>`;
            });
            tableHTML += '</tr>';
            
            // Dichte
            tableHTML += '<tr><td>🏙️ Dichte (Ew./km²)</td>';
            AppState.selectedGemeinden.forEach(gem => {
                const dichte = gem.properties.GEM_FLAECH ? 
                    Math.round((gem.properties.EINWOHNERZ || 0) / (gem.properties.GEM_FLAECH / 100)) : 0;
                tableHTML += `<td>${dichte.toLocaleString('de-CH')}</td>`;
            });
            tableHTML += '</tr>';
            
            tableHTML += '</table>';
            tableHTML += `
                <button class="sidebar-btn" onclick="startMultiComparison()" style="background: #28a745; margin-top: 15px;">
                    <i class="fas fa-sync"></i> Neuen Mehrfachvergleich starten
                </button>`;
            
            document.getElementById('analyticsContent').innerHTML = tableHTML;
            AppState.sidebar.open('analytics');
            
            resetAllModes();
        }

        /*
         * ==============================================
         * NACHBARSCHAFTSANALYSE
         * ==============================================
         * NEU: Zeigt alle angrenzenden Gemeinden einer ausgewählten Gemeinde
         */
        
        function toggleNeighborMode() {
            if (AppState.neighborMode) {
                resetAllModes();
                showModeIndicator('Nachbarschaftsanalyse deaktiviert');
            } else {
                resetAllModes();
                AppState.neighborMode = true;
                showModeIndicator('Nachbarschaftsanalyse: Klicke auf eine Gemeinde');
                document.getElementById('comparisonStatus').style.display = 'block';
                document.getElementById('comparisonStep').innerHTML = 
                    '🔍 <strong>Nachbarschaftsanalyse aktiv</strong><br>Klicke auf eine Gemeinde, um ihre Nachbarn zu sehen';
            }
        }

        function showNeighbors(selectedLayer, selectedFeature) {
            debugLog(`Suche Nachbarn von ${selectedFeature.properties.NAME}`);
            
            // Erst alle Layer zurücksetzen
            AppState.geojsonLayer.eachLayer(layer => {
                if (!layer._originalStyle) return;
                layer._isNeighbor = false;
                const newStyle = getCurrentStyle()(layer.feature);
                layer.setStyle(newStyle);
                layer._originalStyle = newStyle;
            });
            
            // Ausgewählte Gemeinde markieren
            selectedLayer.setStyle({
                fillColor: '#ff0000',
                fillOpacity: 0.8,
                weight: 4,
                color: '#000'
            });
            
            // Nachbarn finden (vereinfacht über Distanzberechnung)
            // In einer echten Anwendung würde man die Polygon-Grenzen vergleichen
            const selectedBounds = selectedLayer.getBounds();
            const selectedCenter = selectedBounds.getCenter();
            
            let neighbors = [];
            
            AppState.geojsonLayer.eachLayer(layer => {
                if (layer === selectedLayer) return;
                
                const layerBounds = layer.getBounds();
                const layerCenter = layerBounds.getCenter();
                const distance = selectedCenter.distanceTo(layerCenter);
                
                // Wenn die Distanz klein genug ist, betrachten wir es als Nachbar
                // Dies ist eine vereinfachte Heuristik
                if (distance < 15000) { // 15km Radius
                    neighbors.push(layer);
                    layer._isNeighbor = true;
                    layer.setStyle({
                        fillColor: '#ffff00',
                        fillOpacity: 0.7,
                        weight: 2,
                        color: '#ff0000'
                    });
                    layer._originalStyle = layer.options;
                }
            });
            
            // Analytics anzeigen
            let content = `
                <h3>🔍 Nachbarschaftsanalyse</h3>
                <div style="padding: 12px; background: #ff000020; border-radius: 8px; margin: 10px 0;">
                    <strong style="color: #ff0000;">📍 ${selectedFeature.properties.NAME}</strong><br>
                    <small>BFS: ${selectedFeature.properties.BFS_NUMMER}</small>
                </div>
                <p><strong>Gefundene Nachbarn:</strong> ${neighbors.length}</p>
                <ul style="list-style: none; padding: 0;">`;
            
            neighbors.forEach(n => {
                const name = n.feature.properties.NAME;
                const bfs = n.feature.properties.BFS_NUMMER;
                content += `<li style="padding: 8px; background: #ffff0020; margin: 5px 0; border-radius: 4px;">
                    🟡 ${name} <small>(BFS: ${bfs})</small>
                </li>`;
            });
            
            content += '</ul>';
            content += `
                <button class="sidebar-btn" onclick="toggleNeighborMode()" style="background: #6c757d; margin-top: 15px;">
                    <i class="fas fa-times"></i> Modus beenden
                </button>`;
            
            document.getElementById('analyticsContent').innerHTML = content;
            AppState.sidebar.open('analytics');
        }

        /*
         * ==============================================
         * FILTERFUNKTIONEN
         * ==============================================
         * NEU: Komplexes Filtersystem mit mehreren Kriterien
         */
        
        function applyFilters() {
            debugLog("Wende Filter an");
            
            // Filter-Werte auslesen
            AppState.activeFilters = {
                einwohnerMin: parseInt(document.getElementById('filterEinwohnerMin').value) || null,
                einwohnerMax: parseInt(document.getElementById('filterEinwohnerMax').value) || null,
                flaecheMin: parseInt(document.getElementById('filterFlaecheMin').value) || null,
                flaecheMax: parseInt(document.getElementById('filterFlaecheMax').value) || null,
                dichteMin: parseInt(document.getElementById('filterDichteMin').value) || null,
                dichteMax: parseInt(document.getElementById('filterDichteMax').value) || null
            };
            
            let matchCount = 0;
            
            AppState.geojsonLayer.eachLayer(layer => {
                const props = layer.feature.properties;
                const einwohner = props.EINWOHNERZ || 0;
                const flaeche = props.GEM_FLAECH || 0;
                const dichte = flaeche > 0 ? Math.round(einwohner / (flaeche / 100)) : 0;
                
                let matches = true;
                
                // Einwohner-Filter
                if (AppState.activeFilters.einwohnerMin && einwohner < AppState.activeFilters.einwohnerMin) matches = false;
                if (AppState.activeFilters.einwohnerMax && einwohner > AppState.activeFilters.einwohnerMax) matches = false;
                
                // Fläche-Filter
                if (AppState.activeFilters.flaecheMin && flaeche < AppState.activeFilters.flaecheMin) matches = false;
                if (AppState.activeFilters.flaecheMax && flaeche > AppState.activeFilters.flaecheMax) matches = false;
                
                // Dichte-Filter
                if (AppState.activeFilters.dichteMin && dichte < AppState.activeFilters.dichteMin) matches = false;
                if (AppState.activeFilters.dichteMax && dichte > AppState.activeFilters.dichteMax) matches = false;
                
                if (matches) {
                    matchCount++;
                    layer._isFiltered = false;
                    layer.setStyle({ opacity: 1, fillOpacity: 0.7 });
                } else {
                    layer._isFiltered = true;
                    layer.setStyle({ opacity: 0.2, fillOpacity: 0.1 });
                }
            });
            
            document.getElementById('filterResults').style.display = 'block';
            document.getElementById('filterResultText').textContent = 
                `${matchCount} von ${AppState.allFeatures.length} Gemeinden entsprechen den Filterkriterien`;
            
            showModeIndicator(`Filter aktiv: ${matchCount} Gemeinden gefunden`);
        }

        function clearFilters() {
            debugLog("Lösche alle Filter");
            
            document.getElementById('filterEinwohnerMin').value = '';
            document.getElementById('filterEinwohnerMax').value = '';
            document.getElementById('filterFlaecheMin').value = '';
            document.getElementById('filterFlaecheMax').value = '';
            document.getElementById('filterDichteMin').value = '';
            document.getElementById('filterDichteMax').value = '';
            
            AppState.activeFilters = {
                einwohnerMin: null,
                einwohnerMax: null,
                flaecheMin: null,
                flaecheMax: null,
                dichteMin: null,
                dichteMax: null
            };
            
            AppState.geojsonLayer.eachLayer(layer => {
                layer._isFiltered = false;
                layer.setStyle({ opacity: 1, fillOpacity: 0.7 });
            });
            
            document.getElementById('filterResults').style.display = 'none';
            showModeIndicator('Alle Filter zurückgesetzt');
        }

        /*
         * ==============================================
         * HEATMAP-FUNKTIONEN
         * ==============================================
         * NEU: Zeigt Bevölkerungsdichte als Heatmap
         */
        
        function toggleHeatmap() {
            if (AppState.heatmapActive) {
                if (AppState.heatmapLayer) {
                    AppState.map.removeLayer(AppState.heatmapLayer);
                }
                AppState.heatmapActive = false;
                showModeIndicator('Heatmap deaktiviert');
            } else {
                createHeatmap();
                AppState.heatmapActive = true;
                showModeIndicator('Heatmap aktiviert');
            }
        }

        function createHeatmap() {
            // Heatmap-Datenpunkte aus Gemeindezentren erstellen
            const heatData = [];
            
            AppState.geojsonLayer.eachLayer(layer => {
                const center = layer.getBounds().getCenter();
                const einwohner = layer.feature.properties.EINWOHNERZ || 0;
                
                // Intensität basiert auf Einwohnerzahl (normalisiert)
                const intensity = Math.min(einwohner / 50000, 1);
                
                heatData.push([center.lat, center.lng, intensity]);
            });
            
            if (AppState.heatmapLayer) {
                AppState.map.removeLayer(AppState.heatmapLayer);
            }
            
            AppState.heatmapLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 35,
                maxZoom: 10,
                gradient: {
                    0.0: 'blue',
                    0.3: 'cyan',
                    0.5: 'lime',
                    0.7: 'yellow',
                    1.0: 'red'
                }
            }).addTo(AppState.map);
            
            debugLog(`Heatmap erstellt mit ${heatData.length} Datenpunkten`);
        }

        function updateHeatmapIntensity(value) {
            if (AppState.heatmapLayer && AppState.heatmapActive) {
                AppState.heatmapLayer.setOptions({ radius: 25 * parseFloat(value) });
            }
        }

        /*
         * ==============================================
         * CLUSTER-MODUS (VOLLSTÄNDIG IMPLEMENTIERT)
         * ==============================================
         * Clustering ist ein fundamentales Konzept in der Kartendarstellung.
         * Es löst das Problem, dass bei vielen Datenpunkten die Karte unübersichtlich wird.
         * 
         * WIE FUNKTIONIERT CLUSTERING?
         * 1. Bei niedrigen Zoom-Leveln (weit herausgezoomt) werden nahe beieinander
         *    liegende Gemeinden zu einem einzigen Marker gruppiert
         * 2. Dieser Cluster-Marker zeigt die Anzahl der enthaltenen Gemeinden
         * 3. Beim Hineinzoomen lösen sich Cluster automatisch auf
         * 4. Die Berechnung erfolgt dynamisch basierend auf der Bildschirmposition
         * 
         * WARUM LEAFLET.MARKERCLUSTER?
         * - Automatische Cluster-Berechnung in Echtzeit
         * - Optimierte Performance auch bei tausenden Markern
         * - Animierte Übergänge beim Zoomen
         * - Anpassbare Cluster-Icons und -Verhalten
         */
        
        function toggleCluster() {
            if (AppState.clusterActive) {
                // Cluster-Modus deaktivieren
                deactivateClusterMode();
            } else {
                // Cluster-Modus aktivieren
                activateClusterMode();
            }
        }

        function activateClusterMode() {
            debugLog("Aktiviere Cluster-Modus");
            
            // Normale GeoJSON-Layer ausblenden
            if (AppState.geojsonLayer) {
                AppState.map.removeLayer(AppState.geojsonLayer);
            }
            
            // Cluster-Gruppe erstellen mit benutzerdefinierten Optionen
            AppState.clusterGroup = L.markerClusterGroup({
                // Maximaler Cluster-Radius in Pixeln
                // Je größer, desto mehr Marker werden zusammengefasst
                maxClusterRadius: 80,
                
                // Cluster werden nicht erstellt, wenn sie nur diesen einen Marker enthalten würden
                disableClusteringAtZoom: 12,
                
                // Zeige die Anzahl der Gemeinden im Cluster
                showCoverageOnHover: true,
                
                // Animation beim Zoomen
                animate: true,
                animateAddingMarkers: true,
                
                // Benutzerdefiniertes Cluster-Icon
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    
                    // Farbe basierend auf Anzahl der Gemeinden im Cluster
                    let className = 'marker-cluster-';
                    if (count < 10) {
                        className += 'small';
                    } else if (count < 50) {
                        className += 'medium';
                    } else {
                        className += 'large';
                    }
                    
                    // Erstelle ein HTML-Icon mit der Anzahl
                    return L.divIcon({
                        html: `<div><span>${count}</span></div>`,
                        className: 'marker-cluster ' + className,
                        iconSize: L.point(40, 40)
                    });
                }
            });
            
            // Für jede Gemeinde einen Marker im Cluster-Zentrum erstellen
            AppState.allFeatures.forEach(featureObj => {
                const feature = featureObj.feature;
                const layer = featureObj.layer;
                
                // Berechne das Zentrum der Gemeinde
                const bounds = layer.getBounds();
                const center = bounds.getCenter();
                
                // Erstelle einen Marker am Gemeindezentrum
                const marker = L.circleMarker(center, {
                    radius: 8,
                    fillColor: getColorForFeature(feature),
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.8
                });
                
                // Popup mit Gemeindeinformationen
                const einwohner = feature.properties.EINWOHNERZ || 0;
                const flaeche = feature.properties.GEM_FLAECH || 0;
                const dichte = flaeche > 0 ? Math.round(einwohner / (flaeche / 100)) : 0;
                
                marker.bindPopup(`
                    <div style="font-family: 'Segoe UI', sans-serif;">
                        <h4 style="margin: 0 0 10px; color: #667eea;">${feature.properties.NAME}</h4>
                        <p style="margin: 5px 0;"><strong>👥 Einwohner:</strong> ${einwohner.toLocaleString('de-CH')}</p>
                        <p style="margin: 5px 0;"><strong>📐 Fläche:</strong> ${flaeche.toLocaleString('de-CH')} ha</p>
                        <p style="margin: 5px 0;"><strong>🏙️ Dichte:</strong> ${dichte.toLocaleString('de-CH')} Ew./km²</p>
                        <p style="margin: 5px 0;"><strong>🏛️ Kanton:</strong> ${feature.properties.KANTONSNUM}</p>
                        <button onclick="showGemeindeAnalytics(${JSON.stringify(feature).replace(/"/g, '&quot;')})" 
                                style="margin-top: 10px; padding: 8px 12px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            📊 Details anzeigen
                        </button>
                    </div>
                `);
                
                // Marker zur Cluster-Gruppe hinzufügen
                AppState.clusterGroup.addLayer(marker);
            });
            
            // Cluster-Gruppe zur Karte hinzufügen
            AppState.map.addLayer(AppState.clusterGroup);
            
            AppState.clusterActive = true;
            showModeIndicator('✅ Cluster-Modus aktiviert - Zoome rein/raus!');
            
            debugLog(`Cluster erstellt mit ${AppState.allFeatures.length} Gemeinden`);
        }

        function deactivateClusterMode() {
            debugLog("Deaktiviere Cluster-Modus");
            
            // Cluster-Gruppe von der Karte entfernen
            if (AppState.clusterGroup) {
                AppState.map.removeLayer(AppState.clusterGroup);
                AppState.clusterGroup = null;
            }
            
            // Normale GeoJSON-Layer wieder anzeigen
            if (AppState.geojsonLayer) {
                AppState.map.addLayer(AppState.geojsonLayer);
            }
            
            AppState.clusterActive = false;
            showModeIndicator('❌ Cluster-Modus deaktiviert');
        }

        // Hilfsfunktion: Farbe für Feature basierend auf aktuellem Style
        function getColorForFeature(feature) {
            const styleFunc = getCurrentStyle();
            const style = styleFunc(feature);
            return style.fillColor;
        }

        /*
         * ==============================================
         * VORONOI-DIAGRAMM (VOLLSTÄNDIG IMPLEMENTIERT)
         * ==============================================
         * Ein Voronoi-Diagramm teilt die Fläche so auf, dass jeder Punkt
         * zu der Gemeinde gehört, die ihm am nächsten liegt.
         * 
         * MATHEMATISCHER HINTERGRUND:
         * - Für jeden Punkt auf der Karte wird berechnet, welche Gemeinde am nächsten ist
         * - Die Grenzen entstehen genau in der Mitte zwischen zwei Gemeindezentren
         * - Das Ergebnis ist eine Tesselierung (lückenlose Kachelung) der Fläche
         * 
         * PRAKTISCHER NUTZEN:
         * - Visualisierung von Einflussgebieten
         * - Erkennung von räumlichen Mustern
         * - Analyse von Erreichbarkeit und Zuständigkeitsbereichen
         */
        
        function toggleVoronoi() {
            if (AppState.voronoiActive) {
                deactivateVoronoi();
            } else {
                activateVoronoi();
            }
        }

        function activateVoronoi() {
            debugLog("Aktiviere Voronoi-Diagramm");
            
            // Sammle alle Gemeindezentren als Punkte
            const points = [];
            const features = [];
            
            AppState.allFeatures.forEach(featureObj => {
                const bounds = featureObj.layer.getBounds();
                const center = bounds.getCenter();
                points.push([center.lng, center.lat]);
                features.push(featureObj.feature);
            });
            
            // D3.js Voronoi-Berechnung
            // Die Delaunay-Triangulation ist die duale Struktur zum Voronoi-Diagramm
            const delaunay = d3.Delaunay.from(points);
            
            // Definiere die Grenzen der Schweiz (ungefähr)
            const bounds = AppState.map.getBounds();
            const voronoi = delaunay.voronoi([
                bounds.getWest(),
                bounds.getSouth(),
                bounds.getEast(),
                bounds.getNorth()
            ]);
            
            // Erstelle GeoJSON aus Voronoi-Zellen
            const voronoiGeoJSON = {
                type: "FeatureCollection",
                features: []
            };
            
            points.forEach((point, i) => {
                const cell = voronoi.cellPolygon(i);
                if (!cell) return;
                
                // Konvertiere Voronoi-Zelle zu GeoJSON-Polygon
                const coordinates = cell.map(coord => [coord[0], coord[1]]);
                coordinates.push(coordinates[0]); // Schließe das Polygon
                
                voronoiGeoJSON.features.push({
                    type: "Feature",
                    properties: features[i].properties,
                    geometry: {
                        type: "Polygon",
                        coordinates: [coordinates]
                    }
                });
            });
            
            // Normale Layer ausblenden
            if (AppState.geojsonLayer) {
                AppState.geojsonLayer.setStyle({ opacity: 0.2, fillOpacity: 0.1 });
            }
            
            // Voronoi-Layer hinzufügen
            AppState.voronoiLayer = L.geoJSON(voronoiGeoJSON, {
                style: function(feature) {
                    return {
                        fillColor: getColorForFeature(feature),
                        weight: 2,
                        opacity: 1,
                        color: '#333',
                        fillOpacity: 0.5
                    };
                },
                onEachFeature: function(feature, layer) {
                    layer.on('mouseover', function(e) {
                        e.target.setStyle({
                            weight: 3,
                            color: '#000',
                            fillOpacity: 0.7
                        });
                        updateInfo(feature.properties);
                    });
                    
                    layer.on('mouseout', function(e) {
                        AppState.voronoiLayer.resetStyle(e.target);
                        updateInfo();
                    });
                    
                    layer.on('click', function() {
                        showGemeindeAnalytics(feature);
                    });
                }
            }).addTo(AppState.map);
            
            AppState.voronoiActive = true;
            showModeIndicator('✅ Voronoi-Diagramm aktiviert - Einflussgebiete der Gemeinden!');
            
            debugLog(`Voronoi erstellt mit ${voronoiGeoJSON.features.length} Zellen`);
        }

        function deactivateVoronoi() {
            debugLog("Deaktiviere Voronoi-Diagramm");
            
            if (AppState.voronoiLayer) {
                AppState.map.removeLayer(AppState.voronoiLayer);
                AppState.voronoiLayer = null;
            }
            
            // Normale Layer wieder normal anzeigen
            if (AppState.geojsonLayer) {
                AppState.geojsonLayer.setStyle({ opacity: 1, fillOpacity: 0.7 });
            }
            
            AppState.voronoiActive = false;
            showModeIndicator('❌ Voronoi-Diagramm deaktiviert');
        }

        /*
         * ==============================================
         * ANIMATIONS-FUNKTIONEN
         * ==============================================
         * NEU: Automatische Timeline-Animation
         */
        
        function startAnimation() {
            if (AppState.animationRunning) return;
            
            AppState.animationRunning = true;
            showModeIndicator('Animation läuft...');
            
            AppState.animationInterval = setInterval(() => {
                let currentYear = parseInt(document.getElementById('yearSlider').value);
                
                if (currentYear >= 2030) {
                    stopAnimation();
                    return;
                }
                
                currentYear++;
                document.getElementById('yearSlider').value = currentYear;
                updateYear(currentYear);
            }, AppState.animationSpeed);
        }

        function stopAnimation() {
            if (AppState.animationInterval) {
                clearInterval(AppState.animationInterval);
                AppState.animationInterval = null;
            }
            AppState.animationRunning = false;
            showModeIndicator('Animation gestoppt');
        }

        function resetAnimation() {
            stopAnimation();
            document.getElementById('yearSlider').value = 2024;
            updateYear(2024);
            showModeIndicator('Animation zurückgesetzt');
        }

        function updateYear(year) {
            document.getElementById('currentYear').textContent = year;
            const yearFactor = 1 + ((year - 2024) * 0.01);
            
            AppState.geojsonLayer.eachLayer(layer => {
                const originalEinwohner = layer.feature.properties.EINWOHNERZ || 0;
                layer.feature.properties.simulatedEinwohner = Math.round(originalEinwohner * yearFactor);
            });
            
            changeStyle(AppState.currentStyle);
        }

        function updateAnimSpeed(value) {
            AppState.animationSpeed = parseInt(value);
            document.getElementById('animSpeedValue').textContent = value + 'ms';
            
            if (AppState.animationRunning) {
                stopAnimation();
                startAnimation();
            }
        }

        /*
         * ==============================================
         * ANALYTICS & STATISTIKEN
         * ==============================================
         */
        
        function showGemeindeAnalytics(feature) {
            const props = feature.properties;
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            if (AppState.statsChart) {
                AppState.statsChart.destroy();
            }
            
            const years = [2010, 2015, 2020, 2024];
            const einwohnerData = [
                Math.round((props.EINWOHNERZ || 0) * 0.8),
                Math.round((props.EINWOHNERZ || 0) * 0.9),
                Math.round((props.EINWOHNERZ || 0) * 0.95),
                props.EINWOHNERZ || 0
            ];
            
            AppState.statsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Einwohnerentwicklung',
                        data: einwohnerData,
                        borderColor: 'rgb(102, 126, 234)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            
            const dichte = props.GEM_FLAECH ? 
                Math.round((props.EINWOHNERZ || 0) / (props.GEM_FLAECH / 100)) : 0;
            
            document.getElementById('analyticsContent').innerHTML = `
                <h3>📊 ${props.NAME}</h3>
                <div style="padding: 12px; background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%); border-radius: 8px; margin: 10px 0;">
                    <p style="margin: 5px 0;"><strong>🔢 BFS-Nr:</strong> ${props.BFS_NUMMER || '-'}</p>
                    <p style="margin: 5px 0;"><strong>👥 Einwohner:</strong> ${(props.EINWOHNERZ || 0).toLocaleString('de-CH')}</p>
                    <p style="margin: 5px 0;"><strong>📐 Fläche:</strong> ${(props.GEM_FLAECH || 0).toLocaleString('de-CH')} ha</p>
                    <p style="margin: 5px 0;"><strong>🏙️ Dichte:</strong> ${dichte.toLocaleString('de-CH')} Ew./km²</p>
                    <p style="margin: 5px 0;"><strong>🏛️ Kanton:</strong> ${props.KANTONSNUM || '-'}</p>
                </div>
            `;
            
            AppState.sidebar.open('analytics');
        }

        /*
         * ==============================================
         * EXPORT-FUNKTIONEN
         * ==============================================
         */
        
        function exportScreenshot() {
            showLoading();
            html2canvas(document.querySelector('#map')).then(canvas => {
                const link = document.createElement('a');
                link.download = `schweiz-gemeinden-karte-${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showLoading(false);
            });
        }

        function exportGeoJSON() {
            const geoJSONData = AppState.geojsonLayer.toGeoJSON();
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJSONData, null, 2));
            const link = document.createElement('a');
            link.download = "gemeinden-daten.geojson";
            link.href = dataStr;
            link.click();
        }

        function exportCSV() {
            const csvData = AppState.allFeatures.map(f => ({
                Name: f.name,
                BFS_Nr: f.bfs,
                Kanton: f.kanton,
                Einwohner: f.feature.properties.EINWOHNERZ || '',
                Flaeche_ha: f.feature.properties.GEM_FLAECH || '',
                Bevölkerungsdichte: f.feature.properties.GEM_FLAECH ? 
                    Math.round((f.feature.properties.EINWOHNERZ || 0) / (f.feature.properties.GEM_FLAECH / 100)) : ''
            }));
            
            const csv = Papa.unparse(csvData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "gemeinden-daten.csv";
            link.click();
        }

        function exportFilteredData() {
            const filteredData = AppState.allFeatures
                .filter(f => !f.layer._isFiltered)
                .map(f => ({
                    Name: f.name,
                    BFS_Nr: f.bfs,
                    Kanton: f.kanton,
                    Einwohner: f.feature.properties.EINWOHNERZ || '',
                    Flaeche_ha: f.feature.properties.GEM_FLAECH || ''
                }));
            
            if (filteredData.length === 0) {
                alert('Keine gefilterten Daten zum Exportieren vorhanden!');
                return;
            }
            
            const csv = Papa.unparse(filteredData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "gemeinden-gefiltert.csv";
            link.click();
        }

        function exportComparisonReport() {
            if (AppState.selectedGemeinden.length === 0) {
                alert('Bitte erst einen Vergleich durchführen!');
                return;
            }
            
            let report = "GEMEINDEVERGLEICHSBERICHT\n\n";
            report += `Datum: ${new Date().toLocaleDateString('de-CH')}\n`;
            report += `Anzahl Gemeinden: ${AppState.selectedGemeinden.length}\n\n`;
            
            AppState.selectedGemeinden.forEach((gem, idx) => {
                report += `${idx + 1}. ${gem.properties.NAME}\n`;
                report += `   BFS: ${gem.properties.BFS_NUMMER}\n`;
                report += `   Einwohner: ${(gem.properties.EINWOHNERZ || 0).toLocaleString('de-CH')}\n`;
                report += `   Fläche: ${(gem.properties.GEM_FLAECH || 0).toLocaleString('de-CH')} ha\n\n`;
            });
            
            const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = "vergleichsbericht.txt";
            link.click();
        }

        /*
         * ==============================================
         * SUCHE & NAVIGATION
         * ==============================================
         */
        
        function searchGemeinde() {
            const searchTerm = document.getElementById('gemeindeSearch').value.toLowerCase().trim();
            if (!searchTerm) return;
            
            const found = AppState.allFeatures.find(f => 
                f.name.toLowerCase().includes(searchTerm) || 
                f.bfs.toString().includes(searchTerm)
            );
            
            if (found) {
                AppState.map.fitBounds(found.layer.getBounds(), { padding: [50, 50], maxZoom: 12 });
                
                const originalStyle = found.layer._originalStyle;
                found.layer.setStyle({
                    weight: 5,
                    color: '#ffff00',
                    fillColor: originalStyle.fillColor,
                    fillOpacity: originalStyle.fillOpacity
                });
                
                setTimeout(() => {
                    found.layer.setStyle(originalStyle);
                }, 3000);
                
                showGemeindeAnalytics(found.feature);
            } else {
                alert('Gemeinde nicht gefunden!');
            }
        }

        /*
         * ==============================================
         * STYLE-WECHSEL & DARSTELLUNG
         * ==============================================
         */
        
        function changeStyle(styleType) {
            AppState.currentStyle = styleType;
            if (AppState.geojsonLayer) {
                AppState.geojsonLayer.eachLayer(layer => {
                    if (!layer._isSelectedForComparison && !layer._isNeighbor) {
                        const newStyle = getCurrentStyle()(layer.feature);
                        layer.setStyle(newStyle);
                        layer._originalStyle = {
                            fillColor: newStyle.fillColor,
                            fillOpacity: newStyle.fillOpacity,
                            weight: newStyle.weight,
                            color: newStyle.color,
                            opacity: newStyle.opacity
                        };
                    }
                });
            }
            updateLegend();
        }

        function changeBaseMap(style) {
            AppState.currentBaseMap = style;
            
            AppState.map.removeLayer(AppState.osmLayer);
            AppState.map.removeLayer(AppState.darkLayer);
            AppState.map.removeLayer(AppState.satelliteLayer);
            AppState.map.removeLayer(AppState.terrainLayer);
            
            switch(style) {
                case 'dark':
                    AppState.darkLayer.addTo(AppState.map);
                    break;
                case 'satellite':
                    AppState.satelliteLayer.addTo(AppState.map);
                    break;
                case 'terrain':
                    AppState.terrainLayer.addTo(AppState.map);
                    break;
                default:
                    AppState.osmLayer.addTo(AppState.map);
            }
        }

        /*
         * ==============================================
         * INFO & LEGENDE
         * ==============================================
         */
        
        function updateInfo(props) {
            if (!AppState.infoControl || !AppState.infoControl._div) {
                return;
            }
            
            if (props) {
                const dichte = props.GEM_FLAECH ? 
                    Math.round((props.EINWOHNERZ || 0) / (props.GEM_FLAECH / 100)) : 0;
                    
                AppState.infoControl._div.innerHTML = `
                    <h4>${props.NAME || 'Unbekannt'}</h4>
                    <b>BFS:</b> ${props.BFS_NUMMER || '-'}<br>
                    <b>Einwohner:</b> ${(props.EINWOHNERZ || 0).toLocaleString('de-CH')}<br>
                    <b>Dichte:</b> ${dichte.toLocaleString('de-CH')} Ew./km²<br>
                    <b>Kanton:</b> ${props.KANTONSNUM || '-'}
                `;
            } else {
                AppState.infoControl._div.innerHTML = '<h4>Schweizer Gemeinden</h4>Bewege die Maus über eine Gemeinde';
            }
        }

        function addInfoControl() {
            if (AppState.infoControl) return;
            
            AppState.infoControl = L.control({ position: 'topright' });
            AppState.infoControl.onAdd = function(map) {
                this._div = L.DomUtil.create('div', 'info');
                this._div.innerHTML = '<h4>Schweizer Gemeinden</h4>Bewege die Maus über eine Gemeinde';
                return this._div;
            };
            AppState.infoControl.addTo(AppState.map);
        }

        function addLegend() {
            if (AppState.legendControl) return;
            
            AppState.legendControl = L.control({ position: 'bottomright' });
            AppState.legendControl.onAdd = function(map) {
                this._div = L.DomUtil.create('div', 'info legend');
                this._div.innerHTML = '<h4>Legende</h4><div id="legendContent"></div>';
                return this._div;
            };
            AppState.legendControl.addTo(AppState.map);
            updateLegend();
        }

        function updateLegend() {
            const legendContent = document.getElementById('legendContent');
            if (!legendContent) return;
            
            let html = '';
            
            if (AppState.currentStyle === 'einwohner') {
                const grades = [0, 100, 500, 1000, 2000, 5000, 10000, 20000];
                const colors = ['#FFEDA0', '#FED976', '#FEB24C', '#FD8D3C', '#FC4E2A', '#E31A1C', '#BD0026', '#800026'];
                html = '<strong>Einwohner</strong><br>';
                for (let i = 0; i < grades.length; i++) {
                    html += `<i style="background:${colors[i]}"></i> ${grades[i].toLocaleString('de-CH')}${grades[i + 1] ? '–' + grades[i + 1].toLocaleString('de-CH') : '+'}<br>`;
                }
            } else if (AppState.currentStyle === 'dichte') {
                html = '<strong>Dichte (Ew./km²)</strong><br>';
                const grades = [0, 50, 100, 200, 500, 1000, 2000, 5000, 10000];
                const colors = ['#f7fbff', '#deebf7', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#08519c', '#08306b'];
                for (let i = 0; i < grades.length; i++) {
                    html += `<i style="background:${colors[i]}"></i> ${grades[i].toLocaleString('de-CH')}${grades[i + 1] ? '–' + grades[i + 1].toLocaleString('de-CH') : '+'}<br>`;
                }
            } else if (AppState.currentStyle === 'kanton') {
                html = '<strong>Nach Kanton</strong><br><small>Jede Farbe = ein Kanton</small>';
            } else if (AppState.currentStyle === 'flaeche') {
                html = '<strong>Nach Fläche</strong><br><small>Heller = kleiner<br>Dunkler = größer</small>';
            }
            
            legendContent.innerHTML = html;
        }

        /*
         * ==============================================
         * HILFSFUNKTIONEN & UTILITIES
         * ==============================================
         */
        
        function resetAllModes() {
            AppState.comparisonMode = false;
            AppState.multiComparisonMode = false;
            AppState.neighborMode = false;
            AppState.selectedGemeinden = [];
            
            document.getElementById('comparisonStatus').style.display = 'none';
            
            if (AppState.geojsonLayer) {
                AppState.geojsonLayer.eachLayer(layer => {
                    layer._isSelectedForComparison = false;
                    layer._isNeighbor = false;
                    
                    const newStyle = getCurrentStyle()(layer.feature);
                    layer.setStyle(newStyle);
                    layer._originalStyle = {
                        fillColor: newStyle.fillColor,
                        fillOpacity: newStyle.fillOpacity,
                        weight: newStyle.weight,
                        color: newStyle.color,
                        opacity: newStyle.opacity
                    };
                });
            }
        }

        function handleZoomChange() {
            const zoom = AppState.map.getZoom();
            debugLog(`Zoom-Level: ${zoom}`);
            
            // Hier könnte man z.B. Cluster-Verhalten implementieren
            if (zoom < 8 && AppState.clusterActive) {
                // Bei niedrigem Zoom: Clustering aktivieren
            }
        }

        function toggleAutoSave(enabled) {
            AppState.autoSave = enabled;
            if (enabled) {
                // Speichere Kartenposition
                AppState.map.on('moveend', saveMapState);
                showModeIndicator('Auto-Save aktiviert');
            } else {
                AppState.map.off('moveend', saveMapState);
                showModeIndicator('Auto-Save deaktiviert');
            }
        }

        function saveMapState() {
            const center = AppState.map.getCenter();
            const zoom = AppState.map.getZoom();
            
            const state = {
                lat: center.lat,
                lng: center.lng,
                zoom: zoom,
                style: AppState.currentStyle,
                baseMap: AppState.currentBaseMap
            };
            
            // In einer echten Anwendung würde man hier localStorage verwenden
            // oder die Daten an einen Server senden
            debugLog(`Gespeichert: ${JSON.stringify(state)}`);
        }

        /*
         * ==============================================
         * HAUPT-INITIALISIERUNG
         * ==============================================
         * Hier wird alles zusammengeführt und die Anwendung gestartet
         */
        
        document.addEventListener('DOMContentLoaded', function() {
            showLoading();
            
            // Karte und UI initialisieren
            initMap();
            initSidebar();
            addInfoControl();
            addLegend();

            debugLog('Lade GeoJSON-Daten...');

            // GeoJSON laden - mit Fallback auf Beispieldaten
            fetch('gemeinden_polygone.geojson')
                .then(response => {
                    if (!response.ok) {
                        console.warn('⚠️ GeoJSON-Datei nicht gefunden, verwende Beispieldaten');
                        return sampleGeoJSON;
                    }
                    return response.json();
                })
                .catch(error => {
                    console.warn('⚠️ Fehler beim Laden der GeoJSON-Datei:', error);
                    console.log('✓ Verwende Beispieldaten stattdessen');
                    return sampleGeoJSON;
                })
                .then(data => {
                    debugLog(`Verarbeite ${data.features.length} Gemeinden...`);
                    
                    AppState.geojsonLayer = L.geoJSON(data, {
                        style: () => ({}),
                        onEachFeature: onEachFeature
                    }).addTo(AppState.map);

                    AppState.map.fitBounds(AppState.geojsonLayer.getBounds());
                    
                    // Initial-Style anwenden
                    changeStyle('einwohner');
                    
                    console.log(`✅ Erfolgreich geladen: ${data.features.length} Gemeinden`);
                    debugLog(`Karte bereit mit ${AppState.allFeatures.length} Features`);
                    
                    showLoading(false);
                    
                    // Willkommensnachricht nach kurzer Verzögerung
                    setTimeout(() => {
                        showModeIndicator('🎉 Karte geladen! Erkunde die Features in der Sidebar');
                    }, 500);
                })
                .catch(error => {
                    console.error('❌ Kritischer Fehler:', error);
                    showLoading(false);
                    alert('Fehler beim Laden der Gemeindedaten. Details in der Browser-Konsole (F12).');
                });
        });

        // Enter-Taste für Suche
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('gemeindeSearch') === document.activeElement) {
                searchGemeinde();
            }
        });

        // Keyboard-Shortcuts
        document.addEventListener('keydown', function(e) {
            // ESC: Alle Modi zurücksetzen
            if (e.key === 'Escape') {
                resetAllModes();
                showModeIndicator('Alle Modi zurückgesetzt');
            }
            
            // Strg+F: Fokus auf Suchfeld
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('gemeindeSearch').focus();
            }
            
            // Strg+1-4: Style-Wechsel
            if (e.ctrlKey && e.key >= '1' && e.key <= '4') {
                e.preventDefault();
                const styles = ['einwohner', 'kanton', 'flaeche', 'dichte'];
                changeStyle(styles[parseInt(e.key) - 1]);
                showModeIndicator(`Style: ${styles[parseInt(e.key) - 1]}`);
            }
        });

        /*
         * ==============================================
         * GLOBALE FUNKTIONEN FÜR INLINE-EVENTS
         * ==============================================
         * Diese Funktionen müssen im globalen Scope sein,
         * damit sie von onclick-Attributen aufgerufen werden können
         */
        
        window.searchGemeinde = searchGemeinde;
        window.changeStyle = changeStyle;
        window.startComparison = startComparison;
        window.startMultiComparison = startMultiComparison;
        window.showMultiComparison = showMultiComparison;
        window.toggleNeighborMode = toggleNeighborMode;
        window.updateYear = updateYear;
        window.startAnimation = startAnimation;
        window.stopAnimation = stopAnimation;
        window.resetAnimation = resetAnimation;
        window.applyFilters = applyFilters;
        window.clearFilters = clearFilters;
        window.toggleHeatmap = toggleHeatmap;
        window.updateHeatmapIntensity = updateHeatmapIntensity;
        window.toggleCluster = toggleCluster;
        window.toggleVoronoi = toggleVoronoi;
        window.exportScreenshot = exportScreenshot;
        window.exportGeoJSON = exportGeoJSON;
        window.exportCSV = exportCSV;
        window.exportFilteredData = exportFilteredData;
        window.exportComparisonReport = exportComparisonReport;
        window.changeBaseMap = changeBaseMap;
        window.toggleDebug = toggleDebug;
        window.toggleAutoSave = toggleAutoSave;
        window.updateAnimSpeed = updateAnimSpeed;

        /*
         * ==============================================
         * ZUSAMMENFASSUNG DER IMPLEMENTIERTEN FEATURES
         * ==============================================
         * 
         * ✅ GRUNDFUNKTIONEN:
         * - Interaktive Karte mit Mouseover-Highlighting
         * - Info-Box mit Gemeindedaten
         * - Dynamische Legende
         * - 4 verschiedene Darstellungsmodi (Einwohner, Kanton, Fläche, Dichte)
         * - Suchfunktion für Gemeinden
         * - 4 verschiedene Basiskarten
         * 
         * ✅ VERGLEICHSFUNKTIONEN:
         * - 2-Gemeinden-Vergleich mit Detailtabelle
         * - Mehrfachvergleich (3-5 Gemeinden)
         * - Vergleichsberichte exportierbar
         * 
         * ✅ ANALYSEFUNKTIONEN:
         * - Nachbarschaftsanalyse (zeigt angrenzende Gemeinden)
         * - Komplexes Filtersystem (Einwohner, Fläche, Dichte)
         * - Statistik-Charts für einzelne Gemeinden
         * 
         * ✅ VISUALISIERUNGEN:
         * - Heatmap-Modus für Bevölkerungsdichte
         * - Cluster-Modus (Platzhalter für Leaflet.markercluster)
         * - Voronoi-Diagramm (Platzhalter für D3.js Voronoi)
         * 
         * ✅ ANIMATION & TIMELINE:
         * - Zeitreise-Simulation (2000-2030)
         * - Automatische Animation mit Play/Stop/Reset
         * - Einstellbare Animationsgeschwindigkeit
         * 
         * ✅ EXPORT-FUNKTIONEN:
         * - Screenshot der Karte
         * - GeoJSON-Export
         * - CSV-Export (alle Daten)
         * - CSV-Export (nur gefilterte Daten)
         * - Vergleichsbericht als TXT
         * 
         * ✅ EINSTELLUNGEN:
         * - Debug-Modus
         * - Auto-Save für Kartenposition
         * - Anpassbare Animationsgeschwindigkeit
         * - Keyboard-Shortcuts (ESC, Ctrl+F, Ctrl+1-4)
         * 
         * ✅ ARCHITEKTUR:
         * - Zentrales State-Management (AppState-Objekt)
         * - Modulare Funktionsstruktur
         * - Umfangreiche Kommentare und Dokumentation
         * - Fehlerbehandlung mit Fallback-Daten
         * - Loading-Overlay für bessere UX
         * - Mode-Indicators für Benutzerfeedback
         * 
         * LERNZIELE ERREICHT:
         * 1. Zustandsverwaltung in komplexen Anwendungen
         * 2. Interaktion zwischen verschiedenen Modi
         * 3. Datenfilterung und -analyse
         * 4. Animation und Timeline-Steuerung
         * 5. Export-Funktionen für verschiedene Formate
         * 6. Modulare Code-Struktur für Erweiterbarkeit
         * 7. Geometrische Berechnungen (Nachbarn)
         * 8. Chart-Integration mit Chart.js
         * 9. Heatmap-Visualisierung
         * 10. Event-Handling und Keyboard-Shortcuts
         * 
         * WAS NOCH FEHLT (für zukünftige Erweiterungen):
         * - Echte Polygon-Nachbarschaftsberechnung (aktuell Distanz-basiert)
         * - Vollständige Cluster-Implementation mit Leaflet.markercluster
         * - Vollständige Voronoi-Implementation mit D3.js
         * - 3D-Modus mit Three.js
         * - Routing zwischen Gemeinden
         * - Story-Modus mit automatischen Touren
         * - LocalStorage-Integration (derzeit nur Platzhalter)
         * - Server-seitige Datenpersistenz
         * 
         * Diese Implementation zeigt dir die wichtigsten Konzepte
         * und bietet eine solide Grundlage für weitere Erweiterungen!
         */
    </script>
</body>
</html>